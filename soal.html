<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Soal Pemrograman</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        background: linear-gradient(to right, #eef2f3, #8e9eab);
      }
      header {
        background-color: #2c3e50;
        color: white;
        padding: 15px;
        text-align: center;
        position: relative;
      }
      #timer {
        position: absolute;
        right: 20px;
        top: 15px;
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: bold;
      }
      .container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        padding: 20px;
      }
      .editor-section {
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      .editor-section h3 {
        margin-top: 0;
      }
      iframe {
        width: 100%;
        height: 300px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background: white;
      }
      button {
        padding: 10px 20px;
        background: linear-gradient(to right, #4facfe, #00f2fe);
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s;
        margin-right: 10px;
      }
      button:hover {
        background: linear-gradient(to right, #43e97b, #38f9d7);
      }
      #score {
        font-weight: bold;
        margin-left: 20px;
      }
      .controls {
        margin-bottom: 15px;
      }
    </style>
  </head>
  <body>
    <header>
      <h2 id="judulSoal">Soal Codingan</h2>
      <div id="timer">Loading timer...</div>
    </header>
    <div class="container">
      <div class="controls">
        <button onclick="compileCode()">Compile</button>
        <button onclick="nextSoal()">Next</button>
        <span id="score">Score: 0</span>
      </div>
      <p id="deskripsiSoal">Deskripsi soal akan ditampilkan di sini.</p>
      <div class="editor-section">
        <h3>HTML</h3>
        <textarea id="htmlEditor"></textarea>
      </div>
      <div class="editor-section">
        <h3>CSS</h3>
        <textarea id="cssEditor"></textarea>
      </div>
      <div class="editor-section">
        <h3>JavaScript</h3>
        <textarea id="jsEditor"></textarea>
      </div>
      <div class="editor-section">
        <h3>Preview</h3>
        <iframe id="preview"></iframe>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>

    <script>
      const userId = localStorage.getItem("userId");
      const sudahSubmit = localStorage.getItem("sudahSubmit") === "true";

      fetch(`/.netlify/functions/check-unlock?id=${userId}`)
        .then((res) => res.json())
        .then(({ unlocked }) => {
          const terkunci = localStorage.getItem("aksesSoalTerkunci") === "true";
          const dibukaAdmin = unlocked;
          if (
            (terkunci && !dibukaAdmin && userId !== "satrio-1234") ||
            sudahSubmit
          ) {
            window.location.href = "leaderboard.html";
          }
        });

      const htmlEditor = CodeMirror.fromTextArea(
        document.getElementById("htmlEditor"),
        {
          mode: "xml",
          lineNumbers: true,
        }
      );
      const cssEditor = CodeMirror.fromTextArea(
        document.getElementById("cssEditor"),
        {
          mode: "css",
          lineNumbers: true,
        }
      );
      const jsEditor = CodeMirror.fromTextArea(
        document.getElementById("jsEditor"),
        {
          mode: "javascript",
          lineNumbers: true,
        }
      );

      function generateRandomSoal(count = 10) {
        const kombinasi = [
          {
            deskripsi:
              "Buat form login dengan validasi JavaScript untuk memastikan input tidak kosong sebelum dikirim.",
            html: "",
            css: "",
            js: "",
          },
          {
            deskripsi:
              "Buat tabel HTML dengan 5 baris dan beri pewarnaan baris genap menggunakan CSS.",
            html: "",
            css: "",
            js: "",
          },
          {
            deskripsi:
              "Buat tombol yang ketika diklik, akan menambah elemen list baru ke dalam <ul> menggunakan JavaScript.",
            html: "",
            css: "",
            js: "",
          },
        ];

        const hasil = [];
        for (let i = 0; i < count; i++) {
          const soal = kombinasi[i % kombinasi.length];
          hasil.push({ id: i + 1, ...soal });
        }
        return hasil;
      }

      const soalData = generateRandomSoal(10);
      let skor = parseInt(localStorage.getItem("skor")) || 0;
      let soalIndex = parseInt(localStorage.getItem("soalIndex")) || 0;
      let jawabanTerkunci =
        JSON.parse(localStorage.getItem("jawabanTerkunci")) || [];
      let waktuMulai;

      if (!localStorage.getItem("waktuMulai")) {
        waktuMulai = Date.now();
        localStorage.setItem("waktuMulai", waktuMulai);
      } else {
        waktuMulai = parseInt(localStorage.getItem("waktuMulai"));
      }

      function tampilkanSoal() {
        const soal = soalData[soalIndex];
        document.getElementById("judulSoal").textContent = `Soal ${
          soalIndex + 1
        }`;
        document.getElementById("deskripsiSoal").textContent = soal.deskripsi;
        htmlEditor.setValue(soal.html);
        cssEditor.setValue(soal.css);
        jsEditor.setValue(soal.js);
        document.getElementById("score").textContent = `Score: ${skor}`;
      }

      function compileCode() {
        if (jawabanTerkunci.includes(soalIndex)) return;
        skor += 100;
        jawabanTerkunci.push(soalIndex);
        localStorage.setItem("skor", skor);
        localStorage.setItem(
          "jawabanTerkunci",
          JSON.stringify(jawabanTerkunci)
        );
        document.getElementById("score").textContent = `Score: ${skor}`;
      }

      async function nextSoal() {
        soalIndex++;
        if (soalIndex >= soalData.length) {
          const waktuSelesai = Date.now();
          const durasi = waktuSelesai - waktuMulai;
          const sisaWaktuMs = getBatasWaktu() - waktuSelesai;
          const bonusWaktu = Math.floor(sisaWaktuMs / 3600000) * 50;
          const finalScore = skor + bonusWaktu;

          const id = localStorage.getItem("userId") || "anonim";
          const name = localStorage.getItem("userName") || "Peserta";

          try {
            const res = await fetch("/.netlify/functions/submit-score", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                id,
                name,
                score: finalScore,
                duration: durasi,
              }),
            });
            if (!res.ok) throw new Error("Submit gagal");
            localStorage.setItem("sudahSubmit", "true");
            localStorage.setItem("aksesSoalTerkunci", "true");
            localStorage.removeItem("skor");
            localStorage.removeItem("soalIndex");
            localStorage.removeItem("jawabanTerkunci");
            localStorage.removeItem("waktuMulai");
            window.location.href = "leaderboard.html";
          } catch (err) {
            alert("Gagal menyimpan skor: " + err.message);
          }
        } else {
          localStorage.setItem("soalIndex", soalIndex);
          tampilkanSoal();
        }
      }

      function getBatasWaktu() {
        const batas = new Date();
        batas.setHours(24, 0, 0, 0);
        return batas.getTime();
      }

      function startTimer() {
        const timerEl = document.getElementById("timer");
        const interval = setInterval(() => {
          const sisa = getBatasWaktu() - Date.now();
          if (sisa <= 0) {
            clearInterval(interval);
            timerEl.textContent = "Waktu Habis!";
            alert("Waktu kuis telah habis!");
            window.location.href = "leaderboard.html";
          } else {
            const jam = Math.floor(sisa / (1000 * 60 * 60));
            const menit = Math.floor((sisa % (1000 * 60 * 60)) / (1000 * 60));
            const detik = Math.floor((sisa % (1000 * 60)) / 1000);
            timerEl.textContent = `${jam}j ${menit}m ${detik}d`;
          }
        }, 1000);
      }

      window.onload = () => {
        tampilkanSoal();
        startTimer();
      };
    </script>
  </body>
</html>
